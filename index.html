<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flashcard-container {
            min-height: 15rem;
            transition: transform 0.5s ease-in-out;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .flashcard-content {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .flashcard-front {
            background-color: #1f2937;
            transform: rotateY(0deg);
        }
        .flashcard-back {
            background-color: #2563eb;
            transform: rotateY(180deg);
        }
        .flipped .flashcard-front {
            transform: rotateY(180deg);
        }
        .flipped .flashcard-back {
            transform: rotateY(360deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-xl flex flex-col items-center">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-400">Flashcard Master</h1>
            <p id="user-id-display" class="text-sm text-gray-400 mt-2"></p>
        </div>

        <div id="content-container" class="w-full"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
        
        // Your hardcoded Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtAMVkkLbsixhhQPjQByDdj2uuJ7k0JHI",
            authDomain: "flashcards-63471.firebaseapp.com",
            projectId: "flashcards-63471",
            storageBucket: "flashcards-63471.firebasestorage.app",
            messagingSenderId: "763890257800",
            appId: "1:763890257800:web:f81542c34eb8b0a965743d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // State management
        let currentView = '';
        let sessions = {};
        let selectedSessionId = null;
        let flashcardSet = [];
        let currentCardIndex = 0;

        // Sample data for flashcards
        const sampleFlashcards = {
            math: {
                '1st': [
                    { question: 'What is $2 + 3$?', answer: '$5$' }, { question: 'What is $5 - 1$?', answer: '$4$' },
                    { question: 'What is $6 + 4$?', answer: '$10$' }, { question: 'What is $9 - 3$?', answer: '$6$' },
                    { question: 'What is $1 + 8$?', answer: '$9$' }, { question: 'What is $7 + 2$?', answer: '$9$' },
                    { question: 'What is $10 - 5$?', answer: '$5$' }, { question: 'What is $4 + 4$?', answer: '$8$' },
                    { question: 'What is $8 - 2$?', answer: '$6$' }, { question: 'What is $3 + 6$?', answer: '$9$' },
                    { question: 'What is $5 + 5$?', answer: '$10$' }, { question: 'What is $10 - 8$?', answer: '$2$' },
                    { question: 'What is $1 + 9$?', answer: '$10$' }, { question: 'What is $7 - 3$?', answer: '$4$' },
                    { question: 'What is $2 + 5$?', answer: '$7$' },
                ],
                '2nd': [
                    { question: 'What is $15 + 7$?', answer: '$22$' }, { question: 'What is $20 - 9$?', answer: '$11$' },
                    { question: 'What is $3 \\times 4$?', answer: '$12$' }, { question: 'What is $18 \\div 2$?', answer: '$9$' },
                    { question: 'What is $25 + 10$?', answer: '$35$' }, { question: 'What is $30 - 15$?', answer: '$15$' },
                    { question: 'What is $5 \\times 6$?', answer: '$30$' }, { question: 'What is $21 \\div 3$?', answer: '$7$' },
                    { question: 'What is $40 + 12$?', answer: '$52$' }, { question: 'What is $50 - 25$?', answer: '$25$' },
                ],
                '3rd': [
                    { question: 'What is $12 \\times 12$?', answer: '$144$' }, { question: 'What is $81 \\div 9$?', answer: '$9$' },
                    { question: 'What is $250 + 75$?', answer: '$325$' }, { question: 'What is $1000 - 450$?', answer: '$550$' },
                    { question: 'What is $15 \\times 7$?', answer: '$105$' }, { question: 'What is $42 \\div 6$?', answer: '$7$' },
                    { question: 'What is the perimeter of a square with a side length of 5 cm?', answer: '$20$ cm' },
                    { question: 'What is the area of a rectangle with length 8 in and width 4 in?', answer: '$32$ square inches' },
                ],
                '4th': [
                    { question: 'What is the value of $12 \\times 15$?', answer: '$180$' },
                    { question: 'What is the product of $25$ and $8$?', answer: '$200$' },
                    { question: 'What is the square root of $64$?', answer: '$8$' },
                    { question: 'What is the decimal equivalent of $3/4$?', answer: '$0.75$' },
                ],
                '5th': [
                    { question: 'What is the value of $1/2 + 1/4$?', answer: '$3/4$' },
                    { question: 'What is the area of a triangle with a base of 10 and height of 5?', answer: '$25$' },
                    { question: 'What is the circumference of a circle with a radius of 2?', answer: '$4\\pi$' },
                    { question: 'What is $3^4$?', answer: '$81$' },
                ],
            },
            writing: {
                '1st': [
                    { question: 'Spell the word for a big red fruit.', answer: 'Apple' },
                    { question: 'Spell the word for a small insect with wings.', answer: 'Bug' },
                    { question: 'Spell the word for the sound a dog makes.', answer: 'Bark' },
                    { question: 'Spell the word for a type of pet with a long tail.', answer: 'Cat' },
                    { question: 'Spell the word for the number after two.', answer: 'Three' },
                    { question: 'Spell the word for a big flying animal.', answer: 'Bird' },
                    { question: 'Spell the word for a place you sleep.', answer: 'Bed' },
                    { question: 'Spell the word for something that lights up at night.', answer: 'Star' },
                ],
                '2nd': [
                    { question: 'Correct the spelling: "hapy"', answer: 'Happy' },
                    { question: 'Correct the spelling: "frend"', answer: 'Friend' },
                    { question: 'What is a noun?', answer: 'A person, place, or thing.' },
                    { question: 'What is a verb?', answer: 'An action word.' },
                    { question: 'What is an adjective?', answer: 'A word that describes a noun.' },
                    { question: 'Write a sentence using the word "run".', answer: 'The boy will run fast.' },
                    { question: 'Correct the spelling: "beautful"', answer: 'Beautiful' },
                ],
                '3rd': [
                    { question: 'Write a sentence using a comma.', answer: 'I like apples, bananas, and oranges.' },
                    { question: 'What is a compound sentence?', answer: 'A sentence with two or more independent clauses.' },
                    { question: 'Correct the spelling: "definately"', answer: 'Definitely' },
                    { question: 'What is a synonym for "big"?', answer: 'Large, gigantic, huge.' },
                    { question: 'What is an antonym for "hot"?', answer: 'Cold' },
                    { question: 'Write a short paragraph about your favorite animal.', answer: 'Responses will vary, but should include a topic sentence and supporting details.' },
                ],
            },
            history: {
                '4th': [
                    { question: 'Who was the first President of the United States?', answer: 'George Washington' },
                    { question: 'In what year did the United States declare independence?', answer: '1776' },
                    { question: 'What ancient civilization built the pyramids?', answer: 'Ancient Egypt' },
                    { question: 'What was the name of the ship the Pilgrims sailed on?', answer: 'The Mayflower' },
                ],
                '5th': [
                    { question: 'Who was the main author of the Declaration of Independence?', answer: 'Thomas Jefferson' },
                    { question: 'What was the Stamp Act?', answer: 'A British tax on colonial documents and paper goods' },
                    { question: 'What was the Boston Tea Party?', answer: 'A protest against British taxes' },
                    { question: 'What major event started in 1861 and ended in 1865 in the U.S.?', answer: 'The Civil War' },
                ],
                '6th': [
                    { question: 'What was the Silk Road?', answer: 'A trade route connecting East and West' },
                    { question: 'What is a democracy?', answer: 'A government where citizens vote for their leaders' },
                    { question: 'Who was Julius Caesar?', answer: 'A Roman general and dictator' },
                    { question: 'What did the Magna Carta do?', answer: 'Limited the power of the king' },
                ],
                '7th': [
                    { question: 'What was the Renaissance?', answer: 'A period of European cultural and artistic rebirth' },
                    { question: 'Who was Martin Luther?', answer: 'The German friar who started the Protestant Reformation' },
                    { question: 'What was the Black Death?', answer: 'A devastating pandemic in the 14th century' },
                    { question: 'Who were the major figures of the Scientific Revolution?', answer: 'Galileo, Copernicus, Newton' },
                ],
            },
            science: {
                '4th': [
                    { question: 'What is the name of the planet closest to the sun?', answer: 'Mercury' },
                    { question: 'What is the process called when a caterpillar turns into a butterfly?', answer: 'Metamorphosis' },
                    { question: 'What is the largest organ in the human body?', answer: 'Skin' },
                    { question: 'What state of matter is water vapor?', answer: 'Gas' },
                ],
                '5th': [
                    { question: 'What is the name of the process by which water turns into a gas?', answer: 'Evaporation' },
                    { question: 'What is the main function of the heart?', answer: 'To pump blood throughout the body' },
                    { question: 'What are the three parts of an atom?', answer: 'Proton, neutron, and electron' },
                    { question: 'What is the Earth\'s largest source of energy?', answer: 'The Sun' },
                ],
                '6th': [
                    { question: 'What is photosynthesis?', answer: 'The process plants use to make food from sunlight' },
                    { question: 'What is the Law of Conservation of Energy?', answer: 'Energy cannot be created or destroyed' },
                    { question: 'What are the three states of matter?', answer: 'Solid, liquid, and gas' },
                    { question: 'What does a barometer measure?', answer: 'Air pressure' },
                ],
                '7th': [
                    { question: 'What is the difference between speed and velocity?', answer: 'Velocity includes direction' },
                    { question: 'What is the chemical formula for water?', answer: '$H_2O$' },
                    { question: 'What is a species?', answer: 'A group of organisms that can reproduce with one another' },
                    { question: 'What is the process by which a cell divides to form two identical cells?', answer: 'Mitosis' },
                ],
            },
            geography: {
                '4th': [
                    { question: 'What is the largest ocean?', answer: 'The Pacific Ocean' },
                    { question: 'What continent is the Amazon Rainforest on?', answer: 'South America' },
                    { question: 'What is a country entirely within the city of Rome, Italy?', answer: 'Vatican City' },
                    { question: 'What is the capital of Japan?', answer: 'Tokyo' },
                ],
                '5th': [
                    { question: 'What is the longest river in the world?', answer: 'The Nile' },
                    { question: 'What is the largest desert in the world?', answer: 'The Sahara Desert' },
                    { question: 'What is the capital of France?', answer: 'Paris' },
                    { question: 'Which mountain range is the longest in the world?', answer: 'The Andes' },
                ],
                '6th': [
                    { question: 'What is a delta?', answer: 'A landform created by deposition of sediment at the mouth of a river' },
                    { question: 'What is the largest country in the world by area?', answer: 'Russia' },
                    { question: 'What is the name of the imaginary line that divides the Earth into the Northern and Southern Hemispheres?', answer: 'The Equator' },
                    { question: 'What is the study of weather and atmosphere called?', answer: 'Meteorology' },
                ],
                '7th': [
                    { question: 'What is the difference between a state and a nation?', answer: 'A state is a political entity, a nation is a cultural entity' },
                    { question: 'What are the five Great Lakes?', answer: 'Huron, Ontario, Michigan, Erie, Superior' },
                    { question: 'What is the capital of Canada?', answer: 'Ottawa' },
                    { question: 'What is a fjord?', answer: 'A long, narrow, deep inlet of the sea between high cliffs' },
                ],
            },
            art: {
                '4th': [
                    { question: 'What are the primary colors?', answer: 'Red, blue, and yellow' },
                    { question: 'What is a sculpture?', answer: 'A three-dimensional work of art' },
                    { question: 'What is a landscape painting?', answer: 'A painting of natural scenery' },
                    { question: 'Who painted the Mona Lisa?', answer: 'Leonardo da Vinci' },
                ],
                '5th': [
                    { question: 'What is a portrait?', answer: 'A painting, photograph, sculpture, or other artistic representation of a person' },
                    { question: 'What is a mosaic?', answer: 'A picture or pattern produced by arranging together small colored pieces of hard material' },
                    { question: 'What is Impressionism?', answer: 'A style of painting that uses small, thin brushstrokes and an emphasis on light' },
                    { question: 'Who is known for painting sunflowers and starry nights?', answer: 'Vincent van Gogh' },
                ],
                '6th': [
                    { question: 'What is the difference between hue and value?', answer: 'Hue is the color itself; value is how light or dark it is' },
                    { question: 'What is a fresco?', answer: 'A painting done rapidly in watercolor on wet plaster on a wall or ceiling' },
                    { question: 'What is Cubism?', answer: 'An early 20th-century art movement that revolutionized European painting and sculpture' },
                    { question: 'What famous artist is known for his melting clocks?', answer: 'Salvador Dalí' },
                ],
            },
            literature: {
                '4th': [
                    { question: 'What is a main character in a story?', answer: 'The most important character, who the story is about' },
                    { question: 'What is a setting?', answer: 'The time and place of a story' },
                    { question: 'What is a fairy tale?', answer: 'A story that often features magical creatures and a moral lesson' },
                    { question: 'Who wrote "Where the Wild Things Are"?', answer: 'Maurice Sendak' },
                ],
                '5th': [
                    { question: 'What is the difference between fiction and nonfiction?', answer: 'Fiction is a made-up story; nonfiction is based on facts' },
                    { question: 'What is an autobiography?', answer: 'A story of a person\'s life written by that person' },
                    { question: 'What is a simile?', answer: 'A comparison using "like" or "as"' },
                    { question: 'What is a metaphor?', answer: 'A direct comparison, saying one thing is another' },
                ],
                '6th': [
                    { question: 'What is a theme in a story?', answer: 'The main idea or underlying message the author wants to convey' },
                    { question: 'What is the plot of a story?', answer: 'The sequence of events in a narrative' },
                    { question: 'Who wrote "Harry Potter"?', answer: 'J.K. Rowling' },
                    { question: 'What is a sonnet?', answer: 'A 14-line poem with a specific rhyme scheme' },
                ],
            },
            spanish: {
                '4th': [
                    { question: 'How do you say "hello" in Spanish?', answer: 'Hola' },
                    { question: 'What does "gracias" mean?', answer: 'Thank you' },
                    { question: 'How do you say "one" in Spanish?', answer: 'Uno' },
                    { question: 'How do you say "red" in Spanish?', answer: 'Rojo' },
                ],
                '5th': [
                    { question: 'How do you say "dog" in Spanish?', answer: 'Perro' },
                    { question: 'How do you say "cat" in Spanish?', answer: 'Gato' },
                    { question: 'What does "¿Cómo estás?" mean?', answer: 'How are you?' },
                    { question: 'What is the Spanish word for "mother"?', answer: 'Madre' },
                ],
                '6th': [
                    { question: 'What are the Spanish words for the days of the week?', answer: 'Lunes, martes, miércoles, jueves, viernes, sábado, domingo' },
                    { question: 'What is the plural form of "el libro"?', answer: 'Los libros' },
                    { question: 'What does "tener" mean?', answer: 'To have' },
                    { question: 'What is the Spanish word for "school"?', answer: 'Escuela' },
                ],
            }
        };

        const contentContainer = document.getElementById('content-container');
        const userIdElement = document.getElementById('user-id-display');
        let userId = '';
        let sessions = {};
        let selectedSessionId = null;
        let flashcardSet = [];
        let currentCardIndex = 0;
        
        // Helper to get the base URL without query parameters
        const getBaseUrl = () => `${window.location.protocol}//${window.location.host}${window.location.pathname}`;

        // --- Functions to manage UI views ---
        const showHomeView = () => {
            currentView = 'home';
            contentContainer.innerHTML = `
                <div class="flex flex-col items-center p-6 bg-gray-800 rounded-xl shadow-lg w-full mb-6">
                    <h2 class="text-3xl font-bold mb-6 text-white text-center">Flashcard App</h2>
                    <button id="create-session-btn"
                        class="w-full px-6 py-3 text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition-all duration-200">
                        Create Flashcard Session
                    </button>
                </div>
                <div class="w-full">
                    <h3 class="text-2xl font-bold text-white mb-4">Your Active Sessions</h3>
                    <div id="sessions-list" class="flex flex-col gap-4">
                        <p class="text-gray-400">Loading sessions...</p>
                    </div>
                </div>
            `;
            document.getElementById('create-session-btn').addEventListener('click', showCreateSessionView);
            
            // Listen for changes in the user's sessions in the database
            const sessionsRef = ref(db, `users/${userId}/sessions`);
            onValue(sessionsRef, (snapshot) => {
                sessions = snapshot.val() || {};
                renderSessionsList();
            });
        };

        const renderSessionsList = () => {
            const sessionsList = document.getElementById('sessions-list');
            if (!sessionsList) return;
            
            const sessionKeys = Object.keys(sessions);
            if (sessionKeys.length === 0) {
                sessionsList.innerHTML = '<p class="text-gray-400">No active sessions found. Create one to get started!</p>';
                return;
            }

            sessionsList.innerHTML = '';
            sessionKeys.forEach(key => {
                const session = sessions[key];
                const sessionEl = document.createElement('div');
                sessionEl.className = 'bg-gray-800 p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-center gap-2';
                sessionEl.innerHTML = `
                    <div class="flex flex-col text-sm sm:text-base">
                        <span class="font-bold text-white">${session.subject.charAt(0).toUpperCase() + session.subject.slice(1)} - ${session.grade.charAt(0).toUpperCase() + session.grade.slice(1)} Grade</span>
                        <span class="text-gray-400">Created: ${new Date(session.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <button class="px-4 py-2 text-white bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-all duration-200"
                            data-action="start" data-session-id="${key}">
                            Start
                        </button>
                        <button class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-all duration-200"
                            data-action="delete" data-session-id="${key}">
                            Delete
                        </button>
                    </div>
                `;
                sessionsList.appendChild(sessionEl);
            });

            sessionsList.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const sessionId = event.target.dataset.sessionId;
                    if (event.target.dataset.action === 'start') {
                        // Navigate to the session URL to handle the start logic
                        window.location.href = `${getBaseUrl()}?sessionid=${sessionId}`;
                    } else if (event.target.dataset.action === 'delete') {
                        deleteSession(sessionId);
                    }
                });
            });
        };

        const showCreateSessionView = (message = null) => {
            currentView = 'createSession';
            contentContainer.innerHTML = `
                <div class="flex flex-col items-center p-6 bg-gray-800 rounded-xl shadow-lg w-full">
                    <h2 class="text-3xl font-bold mb-6 text-white">Create a Session</h2>
                    ${message ? `<div class="text-red-400 mb-4">${message}</div>` : ''}
                    
                    <div class="w-full mb-6">
                        <label for="subject-select" class="block text-white mb-2">Select Subject</label>
                        <select id="subject-select" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>-- Choose a Subject --</option>
                            ${Object.keys(sampleFlashcards).map(subject => `<option value="${subject}">${subject.charAt(0).toUpperCase() + subject.slice(1)}</option>`).join('')}
                        </select>
                    </div>

                    <div class="w-full mb-6">
                        <label for="grade-select" class="block text-white mb-2">Select Grade</label>
                        <select id="grade-select" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>-- Choose a Grade --</option>
                        </select>
                    </div>

                    <button id="start-session-btn"
                        class="w-full px-6 py-3 text-lg font-semibold text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition-all duration-200">
                        Start Session
                    </button>
                    <button id="back-btn"
                        class="w-full mt-4 px-6 py-3 text-lg font-semibold text-gray-300 bg-gray-600 hover:bg-gray-700 rounded-lg shadow-md transition-all duration-200">
                        Back
                    </button>
                </div>
            `;

            const subjectSelect = document.getElementById('subject-select');
            const gradeSelect = document.getElementById('grade-select');
            const startBtn = document.getElementById('start-session-btn');
            const backBtn = document.getElementById('back-btn');

            subjectSelect.addEventListener('change', () => {
                const subject = subjectSelect.value;
                gradeSelect.innerHTML = `<option value="" disabled selected>-- Choose a Grade --</option>`;
                if (subject && sampleFlashcards[subject]) {
                    Object.keys(sampleFlashcards[subject]).forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade.charAt(0).toUpperCase() + grade.slice(1) + ' Grade';
                        gradeSelect.appendChild(option);
                    });
                }
            });

            startBtn.addEventListener('click', () => {
                const subject = subjectSelect.value;
                const grade = gradeSelect.value;
                if (!subject || !grade) {
                    showCreateSessionView('Please select a subject and a grade.');
                    return;
                }
                startSession(subject, grade);
            });

            backBtn.addEventListener('click', showHomeView);
        };

        const showFlashcardSessionView = (message = null) => {
            currentView = 'flashcardSession';
            const currentCard = flashcardSet[currentCardIndex];
            const session = sessions[selectedSessionId];
            if (!session) {
                 window.location.href = getBaseUrl();
                 return;
            }
            contentContainer.innerHTML = `
                <div class="flex flex-col items-center p-6 bg-gray-800 rounded-xl shadow-lg w-full max-w-xl min-h-[30rem]">
                    <h2 class="text-2xl font-bold text-white mb-4 text-center">
                        ${session.subject.charAt(0).toUpperCase() + session.subject.slice(1)} - ${session.grade.charAt(0).toUpperCase() + session.grade.slice(1)} Grade
                    </h2>
                    <div class="text-lg text-gray-400 mb-6">
                        Card ${currentCardIndex + 1} of ${flashcardSet.length}
                    </div>

                    <div id="flashcard" class="flashcard-container rounded-xl w-full cursor-pointer h-72">
                        <div id="flashcard-front" class="flashcard-content rounded-xl text-white">
                            <div class="text-4xl font-semibold mb-4">Question</div>
                            <div class="text-2xl font-light">${currentCard.question}</div>
                        </div>
                        <div id="flashcard-back" class="flashcard-content rounded-xl text-white">
                            <div class="text-4xl font-semibold mb-4">Answer</div>
                            <div class="text-2xl font-light">${currentCard.answer}</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between w-full mt-8">
                        <button id="prev-btn"
                            class="px-6 py-3 text-lg font-semibold text-white rounded-lg shadow-md transition-all duration-200 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <button id="next-btn"
                            class="px-6 py-3 text-lg font-semibold text-white bg-purple-600 hover:bg-purple-700 rounded-lg shadow-md transition-all duration-200">
                            Next
                        </button>
                    </div>
                    
                    <button id="end-session-btn"
                        class="mt-6 px-6 py-3 text-lg font-semibold text-gray-300 bg-gray-600 hover:bg-gray-700 rounded-lg shadow-md transition-all duration-200">
                        End Session
                    </button>
                    ${message ? `<div id="session-message" class="text-green-400 mt-4">${message}</div>` : ''}
                </div>
            `;
            
            const flashcard = document.getElementById('flashcard');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const endBtn = document.getElementById('end-session-btn');

            flashcard.addEventListener('click', () => {
                flashcard.classList.toggle('flipped');
            });
            prevBtn.addEventListener('click', prevCard);
            nextBtn.addEventListener('click', nextCard);
            endBtn.addEventListener('click', () => {
                window.location.href = getBaseUrl();
            });

            if (currentCardIndex === 0) {
                prevBtn.disabled = true;
            }
        };

        // --- Application Logic Functions ---
        const startSession = async (subject, grade) => {
            const cards = sampleFlashcards[subject][grade];
            const newSessionRef = push(ref(db, `users/${userId}/sessions`));
            
            const newSession = {
                subject: subject,
                grade: grade,
                flashcards: JSON.stringify(cards),
                currentCardIndex: 0,
                createdAt: new Date().toISOString()
            };
            
            try {
                await set(newSessionRef, newSession);
                // Redirect to the new session URL
                window.location.href = `${getBaseUrl()}?sessionid=${newSessionRef.key}`;
            } catch (error) {
                console.error("Error creating new session:", error);
                showCreateSessionView('Failed to create session. Please try again.');
            }
        };
        
        const deleteSession = async (sessionId) => {
            const sessionRef = ref(db, `users/${userId}/sessions/${sessionId}`);
            try {
                await remove(sessionRef);
            } catch (error) {
                console.error("Error deleting session:", error);
                showHomeView();
            }
        };

        const loadSession = async (sessionId) => {
            const sessionRef = ref(db, `users/${userId}/sessions/${sessionId}`);
            onValue(sessionRef, (snapshot) => {
                const session = snapshot.val();
                if (session) {
                    selectedSessionId = sessionId;
                    flashcardSet = JSON.parse(session.flashcards);
                    currentCardIndex = session.currentCardIndex || 0;
                    showFlashcardSessionView();
                } else {
                    console.error("Session not found:", sessionId);
                    window.location.href = getBaseUrl(); // Redirect to home
                }
            }, { onlyOnce: true });
        };
        
        const nextCard = async () => {
            const flashcard = document.getElementById('flashcard');
            if (flashcard.classList.contains('flipped')) {
                flashcard.classList.remove('flipped');
            }
            
            // Add a small delay for the flip animation to finish
            setTimeout(async () => {
                if (currentCardIndex < flashcardSet.length - 1) {
                    currentCardIndex++;
                    // Update card index in the database
                    const sessionRef = ref(db, `users/${userId}/sessions/${selectedSessionId}/currentCardIndex`);
                    await set(sessionRef, currentCardIndex);
                    showFlashcardSessionView();
                } else {
                    showFlashcardSessionView("You've completed this session!");
                    document.getElementById('next-btn').disabled = true;
                }
            }, 500);
        };

        const prevCard = async () => {
            const flashcard = document.getElementById('flashcard');
            if (flashcard.classList.contains('flipped')) {
                flashcard.classList.remove('flipped');
            }
            
            setTimeout(async () => {
                if (currentCardIndex > 0) {
                    currentCardIndex--;
                    // Update card index in the database
                    const sessionRef = ref(db, `users/${userId}/sessions/${selectedSessionId}/currentCardIndex`);
                    await set(sessionRef, currentCardIndex);
                    showFlashcardSessionView();
                }
            }, 500);
        };

        // --- Main execution on page load ---
        window.onload = () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdElement.textContent = `User ID: ${userId}`;
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessionId = urlParams.get('sessionid');
                    
                    if (sessionId) {
                        loadSession(sessionId);
                    } else {
                        showHomeView();
                    }
                } else {
                    // Sign in anonymously if no user is found
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        contentContainer.innerHTML = '<div class="text-red-500">Failed to sign in. Please check the console for details.</div>';
                    });
                }
            });
        };
    </script>
</body>
</html>
